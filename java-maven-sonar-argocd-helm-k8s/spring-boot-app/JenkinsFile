pipeline {
    agent any

    environment {
        WORKSPACE_DIR_WINDOWS = "C:/ProgramData/Jenkins/.jenkins/workspace/ultimate-demo"
        WORKSPACE_DIR_UNIX = "/c/ProgramData/Jenkins/.jenkins/workspace/ultimate-demo" // Convert Windows path to Unix path
        DOCKER_IMAGE = "abhishekf5/maven-abhishek-docker-agent:v1"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Run Maven with Docker') {
            steps {
                script {
                    // Ensure Docker is running with the correct absolute path
                    def dockerRunCommand = """
                    docker run -d -t --user root -v /var/run/docker.sock:/var/run/docker.sock \
                    -v ${WORKSPACE_DIR_UNIX}:/workspace -w /workspace \
                    -v ${WORKSPACE_DIR_UNIX}@tmp/:${WORKSPACE_DIR_UNIX}@tmp/ \
                    -e ${env.BUILD_USER} \
                    ${DOCKER_IMAGE} cmd.exe
                    """

                    bat(script: dockerRunCommand, returnStdout: true)
                }
            }
        }
    }
}
