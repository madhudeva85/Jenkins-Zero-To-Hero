pipeline {
    agent any

    environment {
        WORKSPACE_DIR_WINDOWS = "C:/ProgramData/Jenkins/.jenkins/workspace/ultimate-demo"
        WORKSPACE_DIR_UNIX = "/c/ProgramData/Jenkins/.jenkins/workspace/ultimate-demo" // Convert Windows path to Unix path
        DOCKER_IMAGE = "abhishekf5/maven-abhishek-docker-agent:v1"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Run Maven with Docker') {
            steps {
                script {
                    // Build the docker run command
                    def dockerRunCommand = """
                    docker run -t --user root -v /var/run/docker.sock:/var/run/docker.sock \
                    -v ${WORKSPACE_DIR_UNIX}:/workspace -w /workspace \
                    -v ${WORKSPACE_DIR_UNIX}@tmp/:${WORKSPACE_DIR_UNIX}@tmp/ \
                    -e BUILD_USER=${env.BUILD_USER} \
                    ${DOCKER_IMAGE} bash -c "mvn clean install"
                    """

                    // Run the Docker container and capture output
                    def result = bat(script: dockerRunCommand, returnStdout: true, returnStderr: true)
                    echo "Docker Run Result: ${result}"
                }
            }
        }
    }
}
