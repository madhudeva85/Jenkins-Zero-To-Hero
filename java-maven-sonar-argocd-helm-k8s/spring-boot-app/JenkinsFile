pipeline {
    agent any

    environment {
        WORKSPACE_DIR = "C:/ProgramData/Jenkins/.jenkins/workspace/ultimate-demo"
        DOCKER_IMAGE = "abhishekf5/maven-abhishek-docker-agent:v1"
    }

    stages {
        stage('Checkout SCM') {
            steps {
                checkout scm
            }
        }

        stage('Run Maven with Docker') {
            steps {
                script {
                    // Ensure Docker is running with the correct absolute path
                    def dockerRunCommand = """
                    docker run -d -t --user root -v /var/run/docker.sock:/var/run/docker.sock \
                    -v ${WORKSPACE_DIR}:/workspace -w ${WORKSPACE_DIR} \
                    -v ${WORKSPACE_DIR}@tmp/:${WORKSPACE_DIR}@tmp/ \
                    -e ${env.BUILD_USER} \
                    ${DOCKER_IMAGE} cmd.exe
                    """

                    bat(script: dockerRunCommand, returnStdout: true)
                }
            }
        }
    }
}
